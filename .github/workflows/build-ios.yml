name: Build iOS

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Install CocoaPods
      run: |
        sudo gem install cocoapods
        pod --version
    
    - name: Check if workspace exists
      id: check_workspace
      run: |
        cd ${{ github.workspace }}
        if [ -f "VSSHKR.xcworkspace/contents.xcworkspacedata" ]; then
          echo "workspace_exists=true" >> $GITHUB_OUTPUT
          echo "✅ Workspace found - will attempt to build"
        else
          echo "workspace_exists=false" >> $GITHUB_OUTPUT
          echo "ℹ️ Workspace not found - this is expected if project hasn't been created in Xcode yet"
        fi
    
    - name: Install Dependencies
      if: steps.check_workspace.outputs.workspace_exists == 'true'
      run: |
        cd ${{ github.workspace }}
        pod install
    
    - name: Build iOS App
      if: steps.check_workspace.outputs.workspace_exists == 'true'
      continue-on-error: true
      run: |
        cd ${{ github.workspace }}
        xcodebuild clean build \
          -workspace VSSHKR.xcworkspace \
          -scheme VSSHKR \
          -sdk iphonesimulator \
          -destination 'platform=iOS Simulator,name=iPhone 14' \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO
    
    - name: Archive iOS App
      if: steps.check_workspace.outputs.workspace_exists == 'true'
      continue-on-error: true
      run: |
        cd ${{ github.workspace }}
        xcodebuild archive \
          -workspace VSSHKR.xcworkspace \
          -scheme VSSHKR \
          -archivePath ./build/VSSHKR.xcarchive \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO
    
    - name: Export IPA
      if: steps.check_workspace.outputs.workspace_exists == 'true'
      continue-on-error: true
      run: |
        cd ${{ github.workspace }}
        xcodebuild -exportArchive \
          -archivePath ./build/VSSHKR.xcarchive \
          -exportPath ./build \
          -exportOptionsPlist ExportOptions.plist || echo "ExportOptions.plist no encontrado, saltando exportación"
    
    - name: Upload Artifacts
      if: steps.check_workspace.outputs.workspace_exists == 'true'
      continue-on-error: true
      uses: actions/upload-artifact@v3
      with:
        name: iOS-Build
        path: |
          build/
          VSSHKR.xcworkspace
    
    - name: Info - Workspace not found
      if: steps.check_workspace.outputs.workspace_exists == 'false'
      run: |
        echo "════════════════════════════════════════"
        echo "ℹ️ Xcode workspace not found"
        echo "════════════════════════════════════════"
        echo ""
        echo "This is expected if the Xcode project hasn't been created yet."
        echo ""
        echo "To enable automatic builds:"
        echo "1. Create the Xcode project manually in macOS (see FINAL_STEPS.md)"
        echo "2. Run 'pod install' in the project directory"
        echo "3. Commit and push the .xcworkspace file to this repository"
        echo "4. The workflow will then build automatically on each push"
        echo ""
        echo "The workflow will complete successfully once the workspace is added."
