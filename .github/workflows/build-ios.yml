name: Build iOS

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    continue-on-error: true
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Install xcodegen
      run: |
        brew install xcodegen
    
    - name: Generate Xcode Project
      run: |
        cd ${{ github.workspace }}
        if [ -f "project.yml" ]; then
          echo "ğŸ“¦ Generating Xcode project with xcodegen..."
          xcodegen generate
          echo "âœ… Xcode project generated"
        else
          echo "âš ï¸ project.yml not found, skipping project generation"
        fi
    
    - name: Check if workspace exists
      id: check_workspace
      run: |
        cd ${{ github.workspace }}
        if [ -f "VSSHKR.xcworkspace/contents.xcworkspacedata" ] || [ -f "VSSHKR.xcodeproj/project.pbxproj" ]; then
          echo "workspace_exists=true" >> $GITHUB_OUTPUT
          echo "âœ… Workspace/project found - will attempt to build"
        else
          echo "workspace_exists=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ Workspace not found - project generation may have failed"
        fi
    
    - name: Install CocoaPods
      if: steps.check_workspace.outputs.workspace_exists == 'true'
      run: |
        sudo gem install cocoapods
        pod --version
    
    - name: Install Dependencies
      if: steps.check_workspace.outputs.workspace_exists == 'true'
      run: |
        cd ${{ github.workspace }}
        pod install
    
    - name: Build iOS App
      if: steps.check_workspace.outputs.workspace_exists == 'true'
      continue-on-error: true
      run: |
        cd ${{ github.workspace }}
        if [ -f "VSSHKR.xcworkspace/contents.xcworkspacedata" ]; then
          echo "ğŸ”¨ Building with workspace..."
          xcodebuild clean build \
            -workspace VSSHKR.xcworkspace \
            -scheme VSSHKR \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 14' \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO
        elif [ -f "VSSHKR.xcodeproj/project.pbxproj" ]; then
          echo "ğŸ”¨ Building with project..."
          xcodebuild clean build \
            -project VSSHKR.xcodeproj \
            -scheme VSSHKR \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 14' \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO
        fi
    
    - name: Info - Workspace not found
      if: steps.check_workspace.outputs.workspace_exists == 'false'
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "â„¹ï¸ Xcode workspace not found"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "This is expected if the Xcode project hasn't been created yet."
        echo ""
        echo "To enable automatic builds:"
        echo "1. Create the Xcode project manually in macOS (see FINAL_STEPS.md)"
        echo "2. Run 'pod install' in the project directory"
        echo "3. Commit and push the .xcworkspace file to this repository"
        echo "4. The workflow will then build automatically on each push"
        echo ""
        echo "The workflow will complete successfully once the workspace is added."
