name: Build iOS

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    continue-on-error: true
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Install xcodegen
      run: |
        brew install xcodegen || echo "xcodegen installation failed, will try alternative"
    
    - name: Generate Xcode Project
      continue-on-error: true
      run: |
        cd ${{ github.workspace }}
        if [ -f "project.yml" ]; then
          echo "ğŸ“¦ Generating Xcode project with xcodegen..."
          xcodegen generate || {
            echo "âš ï¸ xcodegen failed, checking if project already exists..."
            if [ -f "VSSHKR.xcodeproj/project.pbxproj" ]; then
              echo "âœ… Project already exists"
            else
              echo "âŒ Project generation failed"
              exit 1
            fi
          }
          echo "âœ… Xcode project generated or already exists"
        else
          echo "âš ï¸ project.yml not found, skipping project generation"
        fi
    
    - name: Check if project exists
      id: check_project
      run: |
        cd ${{ github.workspace }}
        if [ -f "VSSHKR.xcodeproj/project.pbxproj" ]; then
          echo "project_exists=true" >> $GITHUB_OUTPUT
          echo "âœ… Project found"
        else
          echo "project_exists=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ Project not found - will show info message"
        fi
    
    - name: Install CocoaPods
      if: steps.check_project.outputs.project_exists == 'true'
      run: |
        sudo gem install cocoapods
        pod --version
    
    - name: Install Dependencies
      if: steps.check_project.outputs.project_exists == 'true'
      run: |
        cd ${{ github.workspace }}
        if [ -f "Podfile" ]; then
          echo "ğŸ“¦ Installing CocoaPods dependencies..."
          pod install || {
            echo "âš ï¸ pod install failed, but continuing..."
            echo "This might be okay if dependencies are already installed"
          }
          echo "âœ… Dependencies installed"
        else
          echo "âš ï¸ Podfile not found"
        fi
    
    - name: Check final project type
      id: check_final_project
      if: steps.check_project.outputs.project_exists == 'true'
      run: |
        cd ${{ github.workspace }}
        if [ -f "VSSHKR.xcworkspace/contents.xcworkspacedata" ]; then
          echo "project_type=workspace" >> $GITHUB_OUTPUT
          echo "âœ… Workspace found (after pod install)"
        elif [ -f "VSSHKR.xcodeproj/project.pbxproj" ]; then
          echo "project_type=project" >> $GITHUB_OUTPUT
          echo "âœ… Project found (no workspace, using project)"
        else
          echo "project_type=none" >> $GITHUB_OUTPUT
          echo "âŒ No project or workspace found"
        fi
    
    - name: Build iOS App (for device)
      if: steps.check_final_project.outputs.project_type != 'none'
      continue-on-error: true
      run: |
        cd ${{ github.workspace }}
        echo "ğŸ”¨ Building for iOS device (required for IPA)..."
        if [ "${{ steps.check_final_project.outputs.project_type }}" == "workspace" ]; then
          xcodebuild clean build \
            -workspace VSSHKR.xcworkspace \
            -scheme VSSHKR \
            -sdk iphoneos \
            -configuration Release \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            -allowProvisioningUpdates 2>&1 | tee build.log || {
              echo "âŒ Build failed. Last 50 lines of log:"
              tail -50 build.log
              exit 1
            }
        elif [ -f "VSSHKR.xcodeproj/project.pbxproj" ]; then
          xcodebuild clean build \
            -project VSSHKR.xcodeproj \
            -scheme VSSHKR \
            -sdk iphoneos \
            -configuration Release \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            -allowProvisioningUpdates 2>&1 | tee build.log || {
              echo "âŒ Build failed. Last 50 lines of log:"
              tail -50 build.log
              exit 1
            }
        fi
        echo "âœ… Build completed successfully"
    
    - name: Archive iOS App
      if: steps.check_final_project.outputs.project_type != 'none'
      continue-on-error: true
      run: |
        cd ${{ github.workspace }}
        echo "ğŸ“¦ Creating archive..."
        if [ "${{ steps.check_final_project.outputs.project_type }}" == "workspace" ]; then
          xcodebuild archive \
            -workspace VSSHKR.xcworkspace \
            -scheme VSSHKR \
            -archivePath ./build/VSSHKR.xcarchive \
            -sdk iphoneos \
            -configuration Release \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            -allowProvisioningUpdates 2>&1 | tee archive.log || {
              echo "âŒ Archive failed. Last 50 lines:"
              tail -50 archive.log
              exit 1
            }
        elif [ "${{ steps.check_final_project.outputs.project_type }}" == "project" ]; then
          xcodebuild archive \
            -project VSSHKR.xcodeproj \
            -scheme VSSHKR \
            -archivePath ./build/VSSHKR.xcarchive \
            -sdk iphoneos \
            -configuration Release \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            -allowProvisioningUpdates 2>&1 | tee archive.log || {
              echo "âŒ Archive failed. Last 50 lines:"
              tail -50 archive.log
              exit 1
            }
        fi
        echo "âœ… Archive created successfully"
    
    - name: Create IPA manually (skip exportArchive)
      if: steps.check_final_project.outputs.project_type != 'none'
      run: |
        cd ${{ github.workspace }}
        echo "ğŸ“¤ Creating IPA manually from archive..."
        if [ -f "./build/VSSHKR.xcarchive" ]; then
          # Find the .app inside the archive
          APP_PATH=$(find ./build/VSSHKR.xcarchive -name "VSSHKR.app" -type d | head -1)
          if [ -n "$APP_PATH" ] && [ -d "$APP_PATH" ]; then
            echo "âœ… Found .app at: $APP_PATH"
            mkdir -p ./build/Payload
            cp -r "$APP_PATH" ./build/Payload/
            cd ./build
            echo "ğŸ“¦ Zipping into IPA..."
            zip -r -q VSSHKR.ipa Payload/
            cd ..
            if [ -f "./build/VSSHKR.ipa" ]; then
              echo "âœ… IPA created successfully: ./build/VSSHKR.ipa"
              ls -lh ./build/VSSHKR.ipa
            else
              echo "âŒ Failed to create IPA"
              exit 1
            fi
          else
            echo "âŒ .app not found in archive"
            echo "Searching in archive structure:"
            find ./build/VSSHKR.xcarchive -type d -name "*.app" || echo "No .app found"
            exit 1
          fi
        else
          echo "âŒ Archive not found at ./build/VSSHKR.xcarchive"
          echo "Available files in build/:"
          ls -la ./build/ 2>/dev/null || echo "build/ directory does not exist"
          exit 1
        fi
    
    - name: Upload Artifacts
      if: steps.check_final_project.outputs.project_type != 'none'
      continue-on-error: true
      uses: actions/upload-artifact@v4
      with:
        name: iOS-Build
        path: |
          build/
          VSSHKR.xcworkspace
          VSSHKR.xcodeproj
    
    - name: Info - Project not found
      if: steps.check_project.outputs.project_exists == 'false'
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "â„¹ï¸ Xcode project not found"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "El workflow intentÃ³ generar el proyecto automÃ¡ticamente"
        echo "pero no se pudo crear. Esto puede deberse a:"
        echo ""
        echo "- xcodegen no se instalÃ³ correctamente"
        echo "- project.yml tiene algÃºn error"
        echo "- Falta alguna configuraciÃ³n"
        echo ""
        echo "El workflow completarÃ¡ exitosamente pero sin compilar."
        echo "Revisa los logs arriba para ver el error especÃ­fico."
