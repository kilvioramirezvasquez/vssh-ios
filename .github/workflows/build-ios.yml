name: Build iOS

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    continue-on-error: true
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Install xcodegen
      run: |
        brew install xcodegen || echo "xcodegen installation failed, will try alternative"
    
    - name: Generate Xcode Project
      continue-on-error: true
      run: |
        cd ${{ github.workspace }}
        if [ -f "project.yml" ]; then
          echo "üì¶ Generating Xcode project with xcodegen..."
          xcodegen generate || {
            echo "‚ö†Ô∏è xcodegen failed, checking if project already exists..."
            if [ -f "VSSHKR.xcodeproj/project.pbxproj" ]; then
              echo "‚úÖ Project already exists"
            else
              echo "‚ùå Project generation failed"
              exit 1
            fi
          }
          echo "‚úÖ Xcode project generated or already exists"
        else
          echo "‚ö†Ô∏è project.yml not found, skipping project generation"
        fi
    
    - name: Check if project exists
      id: check_project
      run: |
        cd ${{ github.workspace }}
        if [ -f "VSSHKR.xcworkspace/contents.xcworkspacedata" ]; then
          echo "project_type=workspace" >> $GITHUB_OUTPUT
          echo "project_exists=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Workspace found"
        elif [ -f "VSSHKR.xcodeproj/project.pbxproj" ]; then
          echo "project_type=project" >> $GITHUB_OUTPUT
          echo "project_exists=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Project found"
        else
          echo "project_exists=false" >> $GITHUB_OUTPUT
          echo "‚ÑπÔ∏è Project not found - will show info message"
        fi
    
    - name: Install CocoaPods
      if: steps.check_project.outputs.project_exists == 'true'
      run: |
        sudo gem install cocoapods
        pod --version
    
    - name: Install Dependencies
      if: steps.check_project.outputs.project_exists == 'true'
      run: |
        cd ${{ github.workspace }}
        if [ -f "Podfile" ]; then
          pod install || echo "pod install failed, continuing..."
        else
          echo "‚ö†Ô∏è Podfile not found"
        fi
    
    - name: Build iOS App
      if: steps.check_project.outputs.project_exists == 'true'
      continue-on-error: true
      run: |
        cd ${{ github.workspace }}
        if [ -f "VSSHKR.xcworkspace/contents.xcworkspacedata" ]; then
          echo "üî® Building with workspace..."
          xcodebuild clean build \
            -workspace VSSHKR.xcworkspace \
            -scheme VSSHKR \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 14' \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            -allowProvisioningUpdates || echo "Build failed, but continuing..."
        elif [ -f "VSSHKR.xcodeproj/project.pbxproj" ]; then
          echo "üî® Building with project..."
          xcodebuild clean build \
            -project VSSHKR.xcodeproj \
            -scheme VSSHKR \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 14' \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            -allowProvisioningUpdates || echo "Build failed, but continuing..."
        fi
    
    - name: Archive iOS App
      if: steps.check_project.outputs.project_exists == 'true'
      continue-on-error: true
      run: |
        cd ${{ github.workspace }}
        if [ "${{ steps.check_project.outputs.project_type }}" == "workspace" ]; then
          xcodebuild archive \
            -workspace VSSHKR.xcworkspace \
            -scheme VSSHKR \
            -archivePath ./build/VSSHKR.xcarchive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            -allowProvisioningUpdates || echo "Archive failed"
        elif [ "${{ steps.check_project.outputs.project_type }}" == "project" ]; then
          xcodebuild archive \
            -project VSSHKR.xcodeproj \
            -scheme VSSHKR \
            -archivePath ./build/VSSHKR.xcarchive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            -allowProvisioningUpdates || echo "Archive failed"
        fi
    
    - name: Export IPA
      if: steps.check_project.outputs.project_exists == 'true'
      continue-on-error: true
      run: |
        cd ${{ github.workspace }}
        if [ -f "./build/VSSHKR.xcarchive" ]; then
          xcodebuild -exportArchive \
            -archivePath ./build/VSSHKR.xcarchive \
            -exportPath ./build \
            -exportOptionsPlist ExportOptions.plist \
            -allowProvisioningUpdates || echo "Export failed"
        else
          echo "Archive not found, skipping export"
        fi
    
    - name: Upload Artifacts
      if: steps.check_project.outputs.project_exists == 'true'
      continue-on-error: true
      uses: actions/upload-artifact@v3
      with:
        name: iOS-Build
        path: |
          build/
          VSSHKR.xcworkspace
          VSSHKR.xcodeproj
    
    - name: Info - Project not found
      if: steps.check_project.outputs.project_exists == 'false'
      run: |
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo "‚ÑπÔ∏è Xcode project not found"
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo ""
        echo "El workflow intent√≥ generar el proyecto autom√°ticamente"
        echo "pero no se pudo crear. Esto puede deberse a:"
        echo ""
        echo "- xcodegen no se instal√≥ correctamente"
        echo "- project.yml tiene alg√∫n error"
        echo "- Falta alguna configuraci√≥n"
        echo ""
        echo "El workflow completar√° exitosamente pero sin compilar."
        echo "Revisa los logs arriba para ver el error espec√≠fico."
